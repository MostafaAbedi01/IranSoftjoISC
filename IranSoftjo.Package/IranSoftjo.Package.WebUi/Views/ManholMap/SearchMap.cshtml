@using IranSoftjo.Package.DataModel
@using Kendo.Mvc.Extensions
@model IEnumerable<IranSoftjo.Package.DataModel.TblManhol>
@{
    Entities _db = new Entities();
    ViewBag.Title = "جستجو منهول و نمایش مختصات بر روی نقشه";
}
@if ((string)Session["SM"] == "Search")
{
    <style>
        #visibilitycollapse {
            visibility: visible;
            width: 10%;
        }
    </style>
    <script>
        var x = $("#txtSearch").val();

    </script>
}
else
{
    <style>
        #visibilitycollapse {
            visibility: collapse;
            width: 0%;
        }
    </style>
}

<script src="~/Scripts/jquery-1.10.2.js"></script>
<script src="~/Scripts/jquery.unobtrusive-ajax.js"></script>
<script src="http://maps.googleapis.com/maps/api/js?key=AIzaSyC4QY3t06BnpiMl-0rgHG9-Pe8MdLlq5W0&sensor=false"></script>
<script type="text/javascript">
    $(document).ready(function () {
        var gmarkers = [];
        var map;
        function initialize() {

            var mapProp = {
                center: new google.maps.LatLng(35.7, 51.4), //India Lat and Lon
                zoom: 11,
                mapTypeId: google.maps.MapTypeId.ROADMAP,

                zoomControl: true,
                zoomControlOptions: {
                    style: google.maps.ZoomControlStyle.DEFAULT,
                },
                disableDoubleClickZoom: true,
                mapTypeControl: true,
                scaleControl: true,
                scrollwheel: true,
                streetViewControl: true,
                draggable: true,
                overviewMapControl: true,
                overviewMapControlOptions: {
                    opened: true,
                },
            };
            map = new google.maps.Map(document.getElementById("googleMap"), mapProp);
        }
        google.maps.event.addDomListener(window, 'load', initialize);

        var x = $("#txtSearch").val();
        $.ajax({
            type: "POST",
            url: '@Url.Action("Search", "ManholMap")', //"../Map/Search"
            contentType: "application/json; charset=utf-8",
            data: JSON.stringify({ "location": x }),
            dataType: "json",
            success: function (data) {
                var table = "<table class='table'>";
                $.each(data, function (index, value) {
                    table += "<tr><td>" + value.CodePm + "</td></tr>";
                    var latlng = new google.maps.LatLng(value.Latitude, value.Longitude);
                    var marker = new google.maps.Marker({
                        position: latlng,
                        icon: "/Package/Manhol/Photo/pinkball.png",
                        map: map
                    });

                    var infowindow = new google.maps.InfoWindow({
                        content: "<div class='infoDiv'>" +
                            " <hr/>" + "<a href='/Manhol/ManholDetails/" + value.TblManholId + "'>  کد پی ام :  " + "<h2>" + value.CodePm + "</h2>" + "</a>" +
                            " <hr/> کد جی آی اس :  " + "<h3>" + value.CodeGis + "</h3>" +
                            " <hr/> کد مکانی :  " + "<h3>" + value.CodeMakani + "</h3>" +
                            " <hr/> تاریخ و ساعت آخرین بازدید :  1394/06/18 09:50" +
                            " <hr/> آدرس :  " + value.Address + "</div>"
                    });
                    google.maps.event.addListener(marker, 'click', function () {
                        infowindow.open(map, marker);
                    });

                    gmarkers.push(marker);

                });
                table += "</table>";
                $("#myData").html(table);

            }

        });

        $("#txtSearch").keyup(function () {
            var x = $("#txtSearch").val();
            for (i = 0; i < gmarkers.length; i++) {
                gmarkers[i].setMap(null);
            }
            $.ajax({
                type: "POST",
                url: '@Url.Action("Search", "ManholMap")', //"../Map/Search"
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify({ "location": x }),
                dataType: "json",
                success: function (data) {
                    var table = "<table class='table'>";
                    $.each(data, function (index, value) {
                        table += "<tr><td>" + value.CodePm + "</td></tr>";
                        var latlng = new google.maps.LatLng(value.Latitude, value.Longitude);
                        var marker = new google.maps.Marker({
                            position: latlng,
                            icon: "/Package/Manhol/Photo/pinkball.png",
                            map: map
                        });

                        var infowindow = new google.maps.InfoWindow({
                            content: "<div class='infoDiv'>" +
                                " <hr/>" + "<a href='/Manhol/ManholDetails/" + value.TblManholId + "'>  کد پی ام :  " + "<h2>" + value.CodePm + "</h2>" + "</a>" +
                                " <hr/> کد جی آی اس :  " + "<h3>" + value.CodeGis + "</h3>" +
                                " <hr/> کد مکانی :  " + "<h3>" + value.CodeMakani + "</h3>" +
                                " <hr/> تاریخ و ساعت آخرین بازدید :  1394/05/18 14:50" +
                                " <hr/> آدرس :  " + value.Address + "</div>"
                        });
                        google.maps.event.addListener(marker, 'click', function () {
                            infowindow.open(map, marker);
                        });

                        gmarkers.push(marker);

                    });
                    table += "</table>";
                    $("#myData").html(table);

                }
            });
        });
    });
</script>
<div class="row">
    <div class="col-md-12">
        <!-- BEGIN BASIC PORTLET-->
        <div class="portlet light portlet-fit ">
            <div class="portlet-title">
                <div class="page-toolbar">
                    <div class="btn-group pull-right">
                        <a class="btn blue btn-outline btn-circle btn-sm" data-close-others="true" data-hover="dropdown" data-toggle="dropdown" href="javascript:;">
                            نمایش بر اساس کد GIS
                            <i class="fa fa-angle-down"></i>
                        </a>
                        <ul class="dropdown-menu pull-right" role="menu">
                            @foreach (var item in _db.TblManhols.Select(d => d.CodeGis).ToList().OrderBy(d => d.Value).Distinct())
                            {
                                <li>
                                    <a href="@Url.Action("SearchMap", "ManholMap", new {id = 0, gisid = item})">
                                        <i class="icon-pointer blue"></i> @item
                                    </a>
                                </li>
                                <li class="divider"> </li>
                            }

                        </ul>
                    </div>
                </div>
                <a class="btn blue btn-outline" href="@Url.Action("SearchMap", "ManholMap", new {id = 0})" type="button">
                    <i class="icon-pointer blue"></i>
                    نمایش لیست امروز
                </a>
                <a class="btn blue btn-outline" href="@Url.Action("SearchMap", "ManholMap", new {id = 100})" type="button">
                    <i class="icon-pointer blue"></i>
                    نمایش 1000 منهول آخر ثبت شده
                </a>
              
                </div>
            <div class="portlet-body">
                <div id="googleMap" class="gmaps"></div>
@*                <div style="width: 60px" id="visibilitycollapse">*@
@*                    @Html.TextBox("txtSearch", null, new { @placeholder = "جستجو" })*@
@*                    <div id="myData">*@
@*                        <table class="table">*@
@*                            @foreach (var item in Model)*@
@*                            {*@
@*                                <tr>*@
@*                                    <td>*@
@*                                        @item.CodePm*@
@*                                    </td>*@
@*                                </tr>*@
@*                            }*@
@*                        </table>*@
@*                    </div>*@
@*                </div>*@

            </div>
        </div>
        <!-- END BASIC PORTLET-->
    </div>
</div>


