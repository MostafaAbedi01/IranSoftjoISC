@using IranSoftjo.Package.DataModel
@using Kendo.Mvc.Extensions
@model IEnumerable<IranSoftjo.Package.DataModel.TblShirkhat>
@{
    Layout = "../Shared/_Layout.cshtml";
    ViewBag.Title = "جستجو شیرخط و نمایش مختصات بر روی نقشه";
    Entities _db = new Entities();
    }
<hgroup class="title">
    <h1>@ViewBag.Title</h1>
    <hr/>
</hgroup>
                      @if ((string) Session["SM"] == "Search")
                      {
                          <style>
                              #visibilitycollapse {
                                  visibility: visible;
                                  width: 10%;
                              }
                          </style>
                          <script>
                              var x = $("#txtSearch").val();
                             
                          </script>
                      }
                      else
                      {
                          <style>
                              #visibilitycollapse {
                                  visibility: collapse;
                                       width: 0%;
                              }
                          </style>
                      }

    <script src="~/Scripts/jquery-1.10.2.js"></script>
    <script src="~/Scripts/jquery.unobtrusive-ajax.js"></script>
    <script src="http://maps.googleapis.com/maps/api/js?key=AIzaSyC4QY3t06BnpiMl-0rgHG9-Pe8MdLlq5W0&sensor=false"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            var gmarkers = [];
            var map;
            function initialize() {

                var mapProp = {
                    center: new google.maps.LatLng(35.7, 51.4), //India Lat and Lon
                    zoom: 11,
                    mapTypeId: google.maps.MapTypeId.ROADMAP,

                    zoomControl: true,
                    zoomControlOptions: {
                        style: google.maps.ZoomControlStyle.DEFAULT,
                    },
                    disableDoubleClickZoom: true,
                    mapTypeControl: true,
                    scaleControl: true,
                    scrollwheel: true,
                    streetViewControl: true,
                    draggable: true,
                    overviewMapControl: true,
                    overviewMapControlOptions: {
                        opened: true,
                    },
                };
                map = new google.maps.Map(document.getElementById("googleMap"), mapProp);
            }
            google.maps.event.addDomListener(window, 'load', initialize);

            var x = $("#txtSearch").val();
            $.ajax({
                type: "POST",
                url: '@Url.Action("Search", "AwtTblShirkhat")', //"../Map/Search"
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify({ "location": x }),
                dataType: "json",
                success: function (data) {
                    var table = "<table class='table'>";
                    $.each(data, function (index, value) {
                        table += "<tr><td>" + value.CodePm + "</td></tr>";
                        var latlng = new google.maps.LatLng(value.Latitude, value.Longitude);
                        var marker = new google.maps.Marker({
                            position: latlng,
                            icon: "/Package/AriaWater/Photo/pinkball.png",
                            map: map
                        });

                        var infowindow = new google.maps.InfoWindow({
                            content: "<div class='infoDiv'>" +
                                " <hr/>" + "<a href='/AwtTblShirkhat/Details/" + value.TblShirkhatId + "'>   " + "</a>" +
                                " <hr/> بازدید کننده : محمدرضا اقدسی " +
                                " <hr/> آدرس :  " + value.Address + "</div>"
                        });
                        google.maps.event.addListener(marker, 'click', function () {
                            infowindow.open(map, marker);
                        });

                        gmarkers.push(marker);

                    });
                    table += "</table>";
                    $("#myData").html(table);

                }

            });

            $("#txtSearch").keyup(function () {
                var x = $("#txtSearch").val();
                for (i = 0; i < gmarkers.length; i++) {
                    gmarkers[i].setMap(null);
                }
                $.ajax({
                    type: "POST",
                    url: '@Url.Action("Search", "AwtTblShirkhat")', //"../Map/Search"
                    contentType: "application/json; charset=utf-8",
                    data: JSON.stringify({ "location": x }),
                    dataType: "json",
                    success: function (data) {
                        var table = "<table class='table'>";
                        $.each(data, function (index, value) {
                            table += "<tr><td>" + value.CodePm + "</td></tr>";
                            var latlng = new google.maps.LatLng(value.Latitude, value.Longitude);
                            var marker = new google.maps.Marker({
                                position: latlng,
                                icon: "/Package/AriaWater/Photo/pinkball.png",
                                map: map
                            });

                            var infowindow = new google.maps.InfoWindow({
                                content: "<div class='infoDiv'>" +
                                    " <hr/>" + "<a href='/AwtTblShirkhat/Details/" + value.TblShirkhatId + "'>   " + "</a>" +
                                    " <hr/> بازدید کننده : محمدرضا اقدسی " +
                                    " <hr/> آدرس :  " + value.Address + "</div>"
                            });
                            google.maps.event.addListener(marker, 'click', function () {
                                infowindow.open(map, marker);
                            });

                            gmarkers.push(marker);

                        });
                        table += "</table>";
                        $("#myData").html(table);

                    }
                });
            });
        });
    </script>

<table>
    <tr>

        <td valign="top"></td>
        <td valign="top">
            <nav style="width: 98% !important;" class="navbar navbar-default" id="main-nav" role="navigation">
                <div class="container">
                    <div class="navbar-header" style="float: left !important;">
                        <a class="sr-only" href="#content">پرش به محتوا</a>
                        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-nav-collapse">
                            <span class="sr-only">منو</span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </button>

                    </div>

                    <div class="collapse navbar-collapse" id="main-nav-collapse" style="margin-right: 0px !important">
                        <ul id="menu-main-menu" class="nav navbar-nav navbar-right" style="float: right !important;">
                            <li id="menu-item">
                                <a href="@Url.Action("SearchMap", "AwtTblShirkhat", new {id = 100})">
                                    <i class="fa fa-search"></i> نمایش 1000 شیرخط آخر ثبت شده
                                </a>
                            </li>
                            <li id="menu-item">
                                <a href="@Url.Action("SearchMap", "AwtTblShirkhat", new {id = 0})">
                                    <i class="fa fa-search"></i> نمایش لیست ثبت شده امروز
                                </a>
                            </li>
                            @*<li class="menu-item  ">
                                <a href="@Url.Action("SearchMap", "Manhol", new {id = -1})">
                                    <i class="fa fa-search"></i> نمایش تمامی منهول ها
                                </a>
                            </li>*@
                            <li class="menu-item  ">
                                <a href="@Url.Action("SearchMap", "AwtTblShirkhat", new {id = -2})">
                                    <i class="fa fa-search"></i> جستجو براساس کد
                                </a>
                            </li>

            
                        </ul>
                    </div>
                    <!-- .navbar-collapse -->
                </div>
                <!--.container-->
            </nav>
        </td>
    </tr>
    <tr>

        <td  valign="top">
            <div style="width: 60px" id="visibilitycollapse">
                @Html.TextBox("txtSearch", null, new { @placeholder = "جستجو" })
                <div id="myData">
                    <table class="table">
                        @foreach (var item in Model)
                        {
                            <tr>
                                <td>
                                    @item.TblCodeTagPm.CodePm
                                </td>
                            </tr>
                        }
                    </table>
                </div>
            </div>
        </td>
        <td valign="top">
            <div id="googleMap" style="width: 98%; height: 600px;"></div>
        </td>
    </tr>
</table>

